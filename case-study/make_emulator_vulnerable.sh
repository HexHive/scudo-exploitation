#!/bin/bash

echo "[+] starting the emulator..."

emulator @pixel -no-window -writable-system &

echo "[+] sleeping until the emulator is ready zzz.."

sleep 20

echo "[+] starting adb..."
adb devices
adb root
echo "[+] making /system rw"
adb shell disable-verity
adb shell remount
adb shell reboot
echo "[+] sleeping until emulator has restarted zzz.."
sleep 20
echo "[+] backporting cve..."
adb root
adb shell remount
adb push /libbinder_cve.so /data/local/tmp
adb push /libcutils_cve.so /data/local/tmp
adb shell cp /data/local/tmp/libbinder_cve.so /system/lib64/libbinder.so
adb shell cp /data/local/tmp/libcutils_cve.so /system/lib64/libcutils.so
echo "[+] restarting system_server to force loading of vulnerable libraries"
PID=$(adb shell pgrep system_server)
adb shell kill -9 $PID
sleep 10 
echo "[+] installing attacker app"
adb install -t attack.apk

echo "[+++++++++++++++++++++++++++++++++++++]"
echo "[+] running exploit		  [+]"
echo "[+++++++++++++++++++++++++++++++++++++]"

python3 run_exp.py
