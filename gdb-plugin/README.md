# Gef plugin for Scudo

The [gef](https://hugsy.github.io/gef/) plugin, to debug heap memory while using the scudo allocator. Since the scudo allocator evolves regularly, but Android devices usually don't have the latest version installed, this repository contains multiple copies of the plugin, for the different version supported.

## Installation

To enable the plugin when gef is already installed, it is as easy as calling `source /path/to/scudo.py`. If you want to load the plugin by default, either add this line to `~/.gdbinit` or set the folder containing the script as the gef extra plugins dir by calling `gef config gef.extra_plugins_dir /path/to/dir/containtaing/script` followed by `gef save`.

In order to test on a normal linux machine with the Scudo allocator, simply set `LD_PRELOAD` to the location of the compiled `libscudo.so`. Alternatively you can also use the builtin setup command by typing `scudo setup /path/to/libscudo.so` inside gef, BEFORE the program to be debugged gets started. This setup command also provides some additional flags to automatically configure quarantine (which is disabled by default). You can use `scudo setup -h` to see the available flags for quarantine.

## Versions

The [scudo-69d4e5ae7b97.py](scudo-69d4e5ae7b97.py) file is a scudo version from early 2023, which was the latest version during the plugin development. `69d4e5ae7b97` is the commit hash in the [official llvm repository](https://github.com/llvm/llvm-project/tree/69d4e5ae7b976ded707e78d033b3490ca9ce0ba7/compiler-rt/lib/scudo/standalone) to which this version corresponds.

The [scudo-15754acc5985.py](scudo-15754acc5985.py) file is a scudo version from middle of 2020, which is the version shipped with Android 11 with security patch state of January 2021. `15754acc5985` is the commit hash in the [official llvm repository](https://github.com/llvm/llvm-project/tree/15754acc5985188509f5eefaefa308393759b822/compiler-rt/lib/scudo/standalone) to which this version corresponds. One notable difference to the latest version is that this version doesn't include BatchGroups yet.

## Usage

All commands provided by the plugin are sub commands of the `scudo` command, which shows a list of all the available subcommands. Generally all sub commands can be called with the `-h` flag to get the syntax needed for that specific sub command.

### Summary list of sub command syntaxes

- `scudo chunk [-h] address`: Shows the header information of the chunk at the supplied address.
- `scudo regions`: Shows a summary list of all the scudo regions.
- `scudo region [-h] [--address ADDRESS] [--size SIZE] [--index INDEX]`: Shows the info about the specified region, which can be supplied either by it's base address, class index it serves or the size of chunks it allocates.
- `scudo batchgroup [-h] [--number NUMBER] address`: Shows the info about the BatchGroup at the given address, or a summary list of `NUMBER` batchgroups starting from the one at the given address. A BatchGroup is the biggest entity in the free list of the primary allocator (not present in the android 11 version)
- `scudo transferbatch [-h] [--number NUMBER] address`: Shows the info about the TransferBatch at the given address, or a summary list of `NUMBER` batchgroups starting from the one at the given address. TransferBatch is the smallest central entity in the free list of the primary allocator, from which chunks are moved to the thread specific free lists.
- `scudo perclass [-h] [thread_index] [index]`: Shows the info about the thread local free list for the given thread and class index, which both default to 0. This is the first place a thread looks for a free chunk to allocate.
- `scudo largeblock [-h] [--number NUMBER] [address]`: Shows the LargeBlock header information for the header at the given address, or the first LargeBlock in the used list if no address is supplied. If `--number` is supplied it instead outputs a summary list of the `NUMBER` LargeBlock's starting at the address. LargeBlock's are the chunks allocated by the secondary allocator, which handles the very big chunks, with the exact size limit depending on the configuration.
